## 1. String decryption

![image](https://user-images.githubusercontent.com/91442807/206192366-96406f89-e717-4e5c-b0cc-4dd5843a8974.png)

-> Cơ bản là lấy `data` xor với `string`

### Script lấy các data cần thiết và xor lại:

```python
from pwn import xor,u32
import idc
import idautils

string_dec_func_addr=0x401290
name_list=[]

for xref in idautils.CodeRefsTo(string_dec_func_addr, 0):

    curr_addr= xref
    info=[]
    count_push=0
    while True:
        
        prev_addr=idc.prev_head(curr_addr)
        inss=idc.generate_disasm_line(prev_addr, 1)
        
        if "push" in inss:
            if "push    offset" in inss:
                if "unk_" in inss:
                    data=inss.replace("push    offset unk_", "")
                    data=int(f'0x{data}',16)
                    count_push+=1
                    info.append(data)
                else:
                    data=u32(idaapi.get_bytes(prev_addr,5)[1:])
                    count_push+=1
                    info.append(data)
            else:
                len_data=idc.get_operand_value(prev_addr,0)
                count_push+=1
                info.append(len_data)

        curr_addr=prev_addr
        
        if count_push==3:
            break
    
    data1=idaapi.get_bytes(info[1], info[2])
    data=idaapi.get_bytes(info[0], info[2])
    name_list.append(xor(data,data1))

print(name_list)
```

### Script lấy các giá trị `dword` cần thiết để đổi tên:

```python
import idc
import idautils

string_dec_func_addr=0x401290

dword_list=[]
for xref in idautils.CodeRefsTo(string_dec_func_addr, 0):
    curr_addr= xref

    while True:
        next_addr=idc.next_head(curr_addr)
        inss= idc.generate_disasm_line(next_addr, 1)

        if 'mov' in inss and 'dword_' in inss and 'eax' in inss:
            dword_val=idc.get_operand_value(next_addr,0)
            dword_list.append(dword_val)
            break
        curr_addr=next_addr

print(dword_list)
```

### Script đổi tên:

```python
dword_vals=[5082596, 5083340, 5083108, 5083284, 5082612, 5083348, 5082804, 5082736, 5082736, 5082400, 5083328, 5083364, 5083376, 5083196, 5083040, 5083044, 5082552, 5082672, 5083064, 5083228, 5082284, 5083220, 5082936, 5082208, 5082524, 5082816, 5082732, 5083304, 5082412, 5082916, 5083012, 5082608, 5082728, 5082280, 5082124, 5082340, 5083060, 5083116, 5082488, 5082088, 5082180, 5082480, 5082516, 5082928, 5083140, 5082592, 5083056, 5082984, 5083192, 5082152, 5082556, 5082204, 5082748, 5082968, 5082708, 5083296, 5082476, 5082484, 5082512, 5082856, 5082912, 5082660, 5083372, 5082448, 5083136, 5082244, 5082196, 5083384, 5082264, 5082636, 5082996, 5082992, 5083244, 5082324, 5082700, 5083216, 5082320, 5083324, 5082724, 5082548, 5082908, 5082276, 5082176, 5082620, 5082852, 5082900, 5083264, 5083360, 5083148, 5082148, 5082228, 5082472, 5083320, 5082772, 5082960, 5082876, 5082392, 5082160, 5082256, 5082100, 5083076, 5082336, 5082460, 5082848, 5082384, 5083004, 5082356, 5083260, 5083152, 5082844, 5082796, 5082296, 5082668, 5082872, 5082456, 5082836, 5082964, 5083212, 5082096, 5082752, 5083052, 5082580, 5082716, 5082656, 5082352, 5083124, 5082436, 5082156, 5082892, 5082316, 5082720, 5082788, 5083000, 5082616, 5083204, 5082120, 5082416, 5082084, 5082684, 5082572, 5082072, 5082092, 5083072, 5082696, 5082744, 5083356, 5082128, 5083032, 5083240, 5082712, 5082920, 5082536, 5082288, 5082388, 5082812, 5082988, 5083236, 5082140, 5082172, 5082076, 5083280, 5083180, 5082164, 5082272, 5082692, 5082376, 5082680, 5082800, 5083368, 5082956, 5082252, 5082972, 5083168, 5082080, 5082624, 5082868, 5082640, 5082240, 5082508, 5083096, 5082768, 5082604, 5083256, 5083084, 5082220, 5082520, 5082824, 5082764, 5083132, 5082864, 5082216, 5082368, 5082784, 5082600, 5082188, 5083188, 5082132, 5082380, 5082544, 5082168, 5083248, 5082860, 5082588, 5082888, 5082136, 5082308, 5082576, 5082144, 5083088, 5083088, 5083088, 5082312, 5082192, 5083344, 5082584, 5083120, 5083172, 5082904, 5082268, 5083268, 5082564, 5082372, 5083016, 5082980, 5083252, 5082500, 5082408, 5082948, 5082932, 5082896, 5082420, 5082792, 5083224, 5082664, 5083312, 5082432, 5082760, 5083292, 5082428, 5083080, 5082468, 5083036, 5082828, 5082292, 5083336, 5082832, 5082532, 5083068, 5082688, 5083048, 5083104, 5083100, 5082528, 5082884, 5082444, 5082632, 5082944, 5083092, 5082260, 5083332, 5082068, 5082652, 5082492, 5083300, 5083380, 5082348, 5082880, 5083232, 5083316, 5083352, 5082740, 5082404, 5083028, 5082840, 5082976, 5082224, 5082780, 5082236, 5082200, 5083288, 5082232, 5082112, 5082504, 5082452, 5082808, 5082644, 5082776, 5082440, 5082424, 5083024, 5083024, 5083200, 5082628, 5082364, 5082820, 5083144, 5083164, 5083184, 5082940, 5083128, 5083276, 5082540, 5082924, 5082756, 5083112, 5082304, 5082568, 5082300, 5083160, 5082108, 5082248, 5082952, 5082344, 5082648, 5082496, 5083272, 5083156, 5082212, 5082360, 5083208, 5082704, 5082396, 5082676, 5083308, 5082116, 5083008, 5082560, 5082328, 5082184, 5082104]

name_list=[b'INSERT_KEY_HERE', b'JohnDoe', b'HAL9TH', b'api.faceit.com', b'/core/v1/nicknames/', b'about', b'Mozilla/5.0 (iPhone; CPU iPhone OS 6_0 like Mac OS X) AppleWebKit/536.26 (KHTML, like Gecko) Version/6.0 Mobile/10A5376e Safari/8536.25', b'C:\\ProgramData\\', b'.exe', b':Zone.Identifier', b'[ZoneTransfer] ZoneId=2', b'Windows', b'ProgramData', b'RECYCLE.BIN', b'Config.Msi', b'System Volume Information', b'msdownld.tmp', b'Recovery', b'Local\\Temp', b'Program Files', b'Recycle.Bin', b'All Users', b'MicrosoftEdge\\Cookies', b'Users\\Public', b'Local\\Packages', b'Local\\NuGet', b'Roaming\\WinRAR', b'Local\\Microsoft', b'Microsoft', b'fee_estimates', b'peers', b'mempool', b'banlist', b'governance', b'mncache', b'mnpayments', b'netfulfilled', b'passwords.txt', b'Login Data', b'Cookies', b'Web Data', b'\\files\\Autofill', b'\\files\\Cookies', b'\\files\\CC', b'\\files\\History', b'\\files\\Downloads', b'\\files\\', b'\\files\\Files', b'hwid', b'os', b'platform', b'profile', b'user', b'cccount', b'fcount', b'telegram', b'ver', b'vaultcli.dll', b'VaultOpenVault', b'VaultCloseVault', b'VaultEnumerateItems', b'VaultGetItem', b'VaultFree', b'SELECT url FROM moz_places', b'%s\\Mozilla\\Firefox\\profiles.ini', b'\\signons.sqlite', b'SELECT encryptedUsername, encryptedPassword, formSubmitURL FROM moz_logins', b'\\logins.json', b'formSubmitURL', b'usernameField', b'encryptedUsername', b'encryptedPassword', b'guid', b'SELECT host, name, value FROM moz_cookies', b'SELECT origin_url, username_value, password_value FROM logins', b'SELECT name, value FROM autofill', b'SELECT name_on_card, expiration_month, expiration_year, card_number_encrypted FROM credit_cards', b'SELECT target_path, tab_url from downloads', b'SELECT url, title from urls', b'SELECT HOST_KEY, is_httponly, path, is_secure, (expires_utc/1000000)-11644480800, name, encrypted_value from cookies', b'C:\\Users\\', b'\\AppData\\Roaming\\FileZilla\\recentservers.xml', b'<Host>', b'<Port>', b'<User>', b'<Pass encoding="base64">', b'Soft: FileZilla\n', b'\\AppData\\Roaming\\.purple\\accounts.xml', b'<protocol>', b'<name>', b'<password>', b'Soft: Pidgin\n', b'\\Thunderbird\\Profiles\\', b'C:\\Program Files (x86)\\Mozilla Thunderbird', b'APPDATA', b'LOCALAPPDATA', b'Thunderbird', b'\\files\\Telegram', b'\\Telegram Desktop\\tdata\\*', b'D877F783D5D3EF8C*', b'\\Telegram Desktop\\tdata\\', b'key_datas', b'\\Telegram Desktop\\tdata\\D877F783D5D3EF8C\\*', b'map*', b'\\Telegram Desktop\\tdata\\D877F783D5D3EF8C\\', b'firefox.exe', b'plugin-container.exe', b'update_notifier.exe', b'Mozilla Firefox', b'\\Mozilla\\Firefox\\Profiles\\', b'Pale Moon', b'\\Moonchild Productions\\Pale Moon\\Profiles\\', b'Waterfox', b'\\Waterfox\\Profiles\\', b'Cyberfox', b'\\8pecxstudios\\Cyberfox\\Profiles\\', b'BlackHawk', b'\\NETGATE Technologies\\BlackHawk\\Profiles\\', b'IceCat', b'\\Mozilla\\icecat\\Profiles\\', b'K-Meleon', b'\\K-Meleon\\', b'Google Chrome', b'\\Google\\Chrome\\User Data\\', b'Chromium', b'\\Chromium\\User Data\\', b'Kometa', b'\\Kometa\\User Data\\', b'Amigo', b'\\Amigo\\User Data\\', b'Torch', b'\\Torch\\User Data\\', b'Orbitum', b'\\Orbitum\\User Data\\', b'Comodo Dragon', b'\\Comodo\\Dragon\\User Data\\', b'Nichrome', b'\\Nichrome\\User Data\\', b'Maxthon5', b'\\Maxthon5\\Users\\', b'Sputnik', b'\\Sputnik\\User Data\\', b'Epic Privacy Browser', b'\\Epic Privacy Browser\\User Data\\', b'Vivaldi', b'\\Vivaldi\\User Data\\', b'CocCoc', b'\\CocCoc\\Browser\\User Data\\', b'URAN', b'\\uCozMedia\\Uran\\User Data\\', b'QIP Surf', b'\\QIP Surf\\User Data\\', b'Cent Browser', b'\\CentBrowser\\User Data\\', b'Elements Browser', b'\\Elements Browser\\User Data\\', b'TorBro Browser', b'\\TorBro\\Profile\\', b'Suhba Browser', b'\\Suhba\\User Data\\', b'Mustang Browser', b'\\Rafotech\\Mustang\\User Data\\', b'Chedot Browser', b'\\Chedot\\User Data\\', b'Brave_Old', b'\\brave\\', b'7Star', b'\\7Star\\7Star\\User Data\\', b'Microsoft Edge', b'\\Microsoft\\Edge\\User Data\\', b'360 Browser', b'\\360Browser\\Browser\\User Data\\', b'QQBrowser', b'\\Tencent\\QQBrowser\\User Data\\', b'Opera', b'\\Opera Software\\Opera Stable\\', b'OperaGX', b'\\Opera Software\\Opera GX Stable\\', b'Local State', b'Cookies', b'%s_%s.txt', b'TRUE', b'FALSE', b'\\Microsoft\\Windows\\Cookies\\Low\\', b'Cookies\\IE_Cookies.txt', b'\\Packages\\Microsoft.MicrosoftEdge_8wekyb3d8bbwe\\AC\\#!001\\MicrosoftEdge\\Cookies\\', b'Cookies\\Edge_Cookies.txt', b'\\files\\Wallets', b'%USERPROFILE%', b'%DESKTOP%', b'KERNEL32.DLL', b'LoadLibraryA', b'GetProcAddress', b'VirtualAllocExNuma', b'gdi32.dll', b'ole32.dll', b'user32.dll', b'psapi.dll', b'BCRYPT.DLL', b'BCryptCloseAlgorithmProvider', b'BCryptDestroyKey', b'BCryptOpenAlgorithmProvider', b'BCryptSetProperty', b'BCryptGenerateSymmetricKey', b'BCryptDecrypt', b'CRYPT32.DLL', b'CryptUnprotectData', b'CryptStringToBinaryA', b'C:\\ProgramData\\nss3.dll', b'NSS_Init', b'NSS_Shutdown', b'PK11_GetInternalKeySlot', b'PK11_FreeSlot', b'PK11_Authenticate', b'PK11SDR_Decrypt', b'advapi32.dll', b'RegOpenKeyExA', b'RegQueryValueExA', b'RegCloseKey', b'RegOpenKeyExW', b'RegGetValueW', b'RegEnumKeyExA', b'RegGetValueA', b'GetUserNameA', b'GetCurrentHwProfileA', b'wininet.dll', b'InternetCloseHandle', b'InternetReadFile', b'HttpSendRequestA', b'HttpOpenRequestA', b'InternetConnectA', b'InternetOpenA', b'HttpAddRequestHeadersA', b'HttpQueryInfoA', b'InternetSetFilePointer', b'InternetOpenUrlA', b'InternetSetOptionA', b'DeleteUrlCacheEntry', b'CreateCompatibleBitmap', b'SelectObject', b'BitBlt', b'DeleteObject', b'CreateDCA', b'GetDeviceCaps', b'CreateCompatibleDC', b'CoCreateInstance', b'CoUninitialize', b'GetDesktopWindow', b'ReleaseDC', b'GetKeyboardLayoutList', b'CharToOemA', b'GetDC', b'wsprintfA', b'EnumDisplayDevicesA', b'GetSystemMetrics', b'GetModuleFileNameExA', b'GetModuleBaseNameA', b'EnumProcessModules', b'TronLink', b'\\Local Extension Settings\\ibnejdfjmmkpcnlpebklmnkoeoihofec\\CURRENT', b'\\Sync Extension Settings\\ibnejdfjmmkpcnlpebklmnkoeoihofec\\CURRENT', b'\\Local Extension Settings\\ibnejdfjmmkpcnlpebklmnkoeoihofec', b'\\Sync Extension Settings\\ibnejdfjmmkpcnlpebklmnkoeoihofec', b'MetaMask', b'\\Local Extension Settings\\nkbihfbeogaeaoehlefnkodbefgpgknn\\CURRENT', b'\\Sync Extension Settings\\nkbihfbeogaeaoehlefnkodbefgpgknn\\CURRENT', b'\\Local Extension Settings\\nkbihfbeogaeaoehlefnkodbefgpgknn', b'\\Sync Extension Settings\\nkbihfbeogaeaoehlefnkodbefgpgknn', b'BinanceChainWallet', b'\\Local Extension Settings\\fhbohimaelbohpjbbldcngcnapndodjp\\CURRENT', b'\\Sync Extension Settings\\fhbohimaelbohpjbbldcngcnapndodjp\\CURRENT', b'\\Local Extension Settings\\fhbohimaelbohpjbbldcngcnapndodjp', b'\\Sync Extension Settings\\fhbohimaelbohpjbbldcngcnapndodjp', b'Authenticator', b'\\Local Extension Settings\\bhghoamapcdpbohphigoooaddinpkbai\\CURRENT', b'\\Sync Extension Settings\\bhghoamapcdpbohphigoooaddinpkbai\\CURRENT', b'\\Local Extension Settings\\bhghoamapcdpbohphigoooaddinpkbai', b'\\Sync Extension Settings\\bhghoamapcdpbohphigoooaddinpkbai', b'Wallets', b'Plugins', b'*wallet*.dat', b'\\Wallets\\', b'keystore', b'Ethereum"', b'\\Ethereum\\', b'Electrum', b'\\Electrum\\wallets\\', b'ElectrumLTC', b'\\Electrum-LTC\\wallets\\', b'Exodus', b'\\Exodus\\', b'exodus.conf.json', b'window-state.json', b'\\Exodus\\exodus.wallet\\', b'passphrase.json', b'seed.seco', b'info.seco', b'ElectronCash', b'\\ElectronCash\\wallets\\', b'default_wallet', b'MultiDoge', b'\\MultiDoge\\', b'multidoge.wallet', b'JAXX', b'\\jaxx\\Local Storage\\', b'file__0.localstorage', b'Atomic', b'\\atomic\\Local Storage\\leveldb\\', b'000003.log', b'CURRENT', b'LOCK', b'LOG', b'MANIFEST-000001', b'0000*', b'Binance', b'\\Binance\\', b'app-store.json', b'Coinomi', b'\\Coinomi\\Coinomi\\wallets\\', b'*.wallet', b'*.config', b'wallet_path', b'SOFTWARE\\monero-project\\monero-core', b'\\Monero\\', b'SELECT fieldname, value FROM moz_formhistory', b'\\files\\Soft', b'\\files\\Soft\\Authy', b'\\Authy Desktop\\Local Storage\\', b'\\Authy Desktop\\Local Storage\\*.localstorage', b'\\Opera Stable\\Local State']

import idc

for i in range(len(name_list)):
    idc.set_name(dword_vals[i], name_list[i].decode(), idaapi.SN_FORCE)
```

-> Kết quả:

![image](https://user-images.githubusercontent.com/91442807/206193282-e227d16e-a4c5-46f9-9591-1964c16a58b0.png)


## Phân tích

+ Tạo một thư mục `files` tại đường dẫn nào đó:

![image](https://user-images.githubusercontent.com/91442807/206193926-2c619832-42c3-4542-b087-2180f388c833.png)

+ Kết các tệp `DLL` từ trên mạng vào thư mục `files`:

![image](https://user-images.githubusercontent.com/91442807/206194633-d010eb31-cdfe-4a31-bb66-031684446aeb.png)

```
freebl3.dll
mozglue.dll
msvcp140.dll
nss3.dll
softokn3.dll
vcruntime140.dll
```
-> Trong đó 4 cái đầu là liên quan đến `firefox` và 2 cái cuối thì liên quan đến `C/C++`

+ Tạo thêm các thư mục mới trong thư mục files:

![image](https://user-images.githubusercontent.com/91442807/206195357-49a0bb35-80fb-4735-9c6c-b52e0a33bc41.png)

```
Autofill\
Cookies\
CC\
History\
Downloads\
Wallets\
Files\
```

+ Sau đó tạo thêm các file `.txt` nữa:

```
passwords.txt
outlook.txt       -> Lưu outlook acount
information.txt
```



- Truy cập các `process`, `đường dẫn file` liên quan đến `các loại trình duyệt`:

![image](https://user-images.githubusercontent.com/91442807/206198246-6e576d3e-c0e4-4113-b95f-76f13737263a.png)

### Thư mục Autofill

- Lấy thông tin auto-complete search trên các browser rồi lưu vào một file `.txt` trong thư mục `Autofill\`:

![image](https://user-images.githubusercontent.com/91442807/206200065-579d707c-c6d4-4a6e-8be7-eb8ab019133f.png)

![image](https://user-images.githubusercontent.com/91442807/206199809-a02f6e1a-85e2-43f7-b516-d232d2a7abae.png)

### Thư mục History

- Lấy thông tin `lịch sử truy cập` từ database rồi lưu kết quả vào một file `.txt` trong thư mục `History\`:

![image](https://user-images.githubusercontent.com/91442807/206204465-7a315fab-f2dc-40d1-8ce2-6539c4eb790a.png)

![image](https://user-images.githubusercontent.com/91442807/206204566-4addaf0b-0b42-402e-a3cf-8598a9683b4c.png)

### File password.txt

- Tìm phần `formSubmitURL` trong file `logins.json` để truy cập vào nội dung của phần đó:

![1](https://user-images.githubusercontent.com/91442807/206206703-0e1d986a-9f2f-4efa-a0dc-147e06e09cda.png)

- Sau đó lưu vào file `password.txt` các nội dung như sau:

![image](https://user-images.githubusercontent.com/91442807/206207463-e67f3d56-4cb6-43bc-8c6c-4805eeabd728.png)

### Thư mục Authy

- Truy cập vào vào các file ở thư mục `leveldb` để lấy thông tin rồi lưu vào thư mục `Soft\Authy\`

![image](https://user-images.githubusercontent.com/91442807/206209066-1bea0bfa-6ccc-4876-a2b6-5471b2c66ebb.png)

### File information.txt

- Lưu các thông tin về máy tính:

```
Version
Date
MachineID
...
Windows
Computer Name
User Name
Processor
...
```

### Thư mục Wallets

- Lưu các thông tin về ví điện tử:

```
Electrum
Exodus
ElectronCash
MultiDoge
JAXX
Atomic
Binance
Coinomi
```

### Lấy ảnh chụp màn hình

![image](https://user-images.githubusercontent.com/91442807/206212888-a03173ea-b219-4d00-87c4-26d9db749404.png)

### Nén

- Sau khi lấy được các thông tin thì chương trình nén thư mục `files` lại thành file `.zip` rồi sau đó gửi qua một `C&C server`

### Dọn dẹp

- Mở `commandline` rồi thực hiện các lệnh sau để xóa các file `DLL` đã tải về lúc trước và tất cả các `straces`:

![image](https://user-images.githubusercontent.com/91442807/206213913-0575194b-f3d5-4e13-9e01-0be01ba11630.png)

![image](https://user-images.githubusercontent.com/91442807/206214015-d1a36bea-69fb-4c4a-b4fb-6f624b6c0f97.png)








