![1](https://user-images.githubusercontent.com/91442807/223988601-1aa26bb7-1ad3-4455-a8e0-ab045c4b2ed9.png)

Cuối chương trình có đoạn jump nhảy tới một đoạn shell code. 

- Dùng debugger và dump ra:

![image](https://user-images.githubusercontent.com/91442807/223989366-2f46cfcf-8850-4ea8-96f7-94348bc540af.png)

### Stage22:

Hàm đầu tiên (entry point):

![image](https://user-images.githubusercontent.com/91442807/223990966-27e06bef-d1dd-4599-8d16-272bdf049236.png)

Đi vào hàm:

![image](https://user-images.githubusercontent.com/91442807/223994006-1df7cf86-4517-4021-8251-3d6e8e366e9a.png)

- Sau khi phân tích có 2 hàm quan trọng là `get_kernel32_base` và `api_resolver`

- Lưu ý rằng đây chỉ là shellcode nên khi mở với IDA có 1 số hàm không nhận diện được nên ta cần load một số thư viện tiêu chuẩn (dùng `Loaded Type Libraries`)

![image](https://user-images.githubusercontent.com/91442807/223995825-7b3dec27-7a69-4556-a8fb-1734e96f3224.png)

![image](https://user-images.githubusercontent.com/91442807/223996291-e8134e1a-65bc-4d23-9273-19f1b0854552.png)

- Ta thấy `v1` sẽ cần load struct `_PEB_LDR_DATA struct` và `i` sẽ là `_LDR_MODULE struct` và kết quả trả về của hàm sẽ là `base image`.

Hàm `api_resolver`:

![1](https://user-images.githubusercontent.com/91442807/223997269-38282889-4eb4-4562-8305-c359d481a6ff.png)

- `base_image` sẽ gắn với struct `_IMAGE_DOS_HEADER`

- `image_file_header` là `_IMAGE_NT_HEADERS`

- `export_dir` là `_IMAGE_EXPORT_DIRECTORY`

- Hash sau khi tính toán sẽ so sánh với tha số thứ 2 của hàm, truy ngược lại từ đầu:

![image](https://user-images.githubusercontent.com/91442807/223998413-d230300b-d2b8-425b-a047-8b81567e9cf7.png)

- Và các giá trị đó nằm ở phía trên của hàm:

![image](https://user-images.githubusercontent.com/91442807/223998600-b9898f32-353a-4969-8d7c-ae1cc91a3710.png)

- Dùng `hashDB` để tìm thuật toán hash.

Cuối hàm lại sử dụng lệnh call để gọi gì đó:

![image](https://user-images.githubusercontent.com/91442807/223999266-6053c8e3-4bc4-4cc2-a5f1-3828ad71712e.png)

- Tiếp tục debug tới đoạn trên:

![image](https://user-images.githubusercontent.com/91442807/223999821-88959c11-9dfe-44f7-b2ed-2c2093c6d513.png)

- Ra thêm đoạn shellcode khác:

![image](https://user-images.githubusercontent.com/91442807/223999954-535a4773-db3f-40f0-900e-1fba3de6a2b2.png)

## Stage 3:

![image](https://user-images.githubusercontent.com/91442807/224000524-09dacdc6-3039-45d0-94dc-16227142afd5.png)

- Sử dụng mấy cái hàm tương tự như trên và thuật toán hash cũng y chang stage 2.

Có 1 hàm  cần quan tâm là `decrypt_config`:

![image](https://user-images.githubusercontent.com/91442807/224001958-beed8e5f-786f-40eb-b2e4-c8df8f1460ff.png)

- Sử dụng thuật toán RC4 để decrypt gì đó: `unk_12CA4` là `key` còn `v1` là `encrypted data`.

Debug để lấy `encrypted data` luôn cho lẹ.

```python
from Crypto.Cipher import ARC4

key=b'R\xab\xdf\x06\xb6\xb1:\xc0\xda-"\xdcl\xd2\xbel \x17i\xe0\x12\xb5\xe6\xec\x0e\xabL\x14sJ\xedQ'
ct= bytes.fromhex('A8 C4 98 01 F1 7B 5F 46 E0 AA 0D 58 5C 54 48 B9 7C E8 11 DB D8 D0 4F 9D 09 88 29 6F B4 A6 21 6A 90 BA 17 A4 F1 4B 8A 5E 47 E4 E0 F9 51 5F 48 98 45 22 F5 33 EA 74 9B C5 30 6F BD 39 82 37 CB 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00')

cipher=ARC4.new(key=key)
print(cipher.decrypt(ct))
```

```
b"!RHY\x0e\x00\x00\x00\xefDV\xb5\x93(B\x7f\xbaCw\xa1\xd1\x92\xaa\x92http://116.202.18.132/blob/q3k6tk.xi8o\x00\x8e\x8a\x1fw\x1e\x17\xb4Q\x83\xcf\xda'w#A\x89$\xc7\x93n\xb3\xcbN\xf3T\x1c`Q\x0f\x1d\xd5B\xc2\x8dS\xaa\x06\xcfl\xf4\xe1n>\xbc\xbc\x8cLp*\x9a1\xf9\x9eD\xe96\x88p%\x87\x84?\xe3\x83M\x0c\xa2\x1d\xf0t\xae:\xab\xfe\x9bH\n\t\xfb\xd2\xdf\x9b\x8a\xe8\x8b@\xad\\\xe6"
```

- Thu được c2 address: `http://116.202.18.132/blob/q3k6tk.xi8o`





