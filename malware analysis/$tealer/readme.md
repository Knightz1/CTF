## 1. Script patch VEH to run 

```python
import pefile 

file_buffer= open("malware.bin", "rb").read()

dridex_pe = pefile.PE(data= file_buffer)

text_start=0
text_size=0

for sec in dridex_pe.sections:
    if '.text' in sec.Name.decode():
        text_start= (sec.VirtualAddress)
        text_size= sec.SizeOfRawData

patched_data= file_buffer[text_start:text_start+text_size].replace(b'\xCC\xC3', b'\xFF\xD0')

file_buffer_1= file_buffer[: text_start] + patched_data + file_buffer[text_start+text_size:]

out= open("patched.bin", "wb")
out.write(file_buffer_1)

print("[+] Done")
```
## 2. Script patch only database with IDA python

```python
import idc

ea = 0
while True:
    ea =  idc.find_binary(ea, idc.SEARCH_NEXT | idc.SEARCH_DOWN, "cc c3")
    #print(ea)
    idc.patch_byte(ea, 0xff)        #ff d0: call eax 
    idc.patch_byte(ea+1, 0xd0)
    if ea == idc.BADADDR:
    	break
```

## 3. API resolving and set comment

```python
from zlib import crc32
import json 

xor_key= 0x38BA5C7B

json_data= json.loads(open("API_list.txt", "rb").read())
api_name= json_data['exports']

api_hash_list= {}

for api in api_name:
    hash_val= crc32(api.encode()) ^ xor_key
    api_hash_list[hash_val] = api

# print(api_hash_list[0x649746EC])

import idautils
import idc

for xref in idautils.CodeRefsTo(0x6815C0, 0):
    curr_addr= xref
    api_resolver_addr= xref
    while True:
        prev_addr= idc.prev_head(curr_addr)
        
        inss= idc.generate_disasm_line(prev_addr, 1)

        if "push" in inss and len(inss) <=20:
            prev_addr= idc.prev_head(prev_addr)
            inss= idc.generate_disasm_line(prev_addr, 1)
            
            if "push" in inss and len(inss) <=20:
                #print(f'{hex(prev_addr)} : {inss}')
                hash_val1= idc.get_operand_value(prev_addr, 0)
                api_found= api_hash_list[hash_val1]

                idc.set_cmt(api_resolver_addr, api_found, 0)
                break
            else:
                break
        
        curr_addr = prev_addr
 ```

## 4. EXCEPTION_POINTERS structure

```python
struct _EXCEPTION_POINTERS
{
  _EXCEPTION_RECORD *ExceptionRecord;
  PCONTEXT ContextRecord;
};
```

## 5. PEB_UNIVERSAL

[link](https://gist.github.com/herrcore/fd355c25c142c53a920c9f082d45c50c#file-peb_universal-h-L30)
